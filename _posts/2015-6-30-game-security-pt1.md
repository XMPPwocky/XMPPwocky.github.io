---
title: Games don't need memory safety- right? Part 1
--- 

[Spoiler alert: yes, they do.](https://en.wikipedia.org/wiki/Betteridge's_law_of_headlines)

Apparently, it's become common knowledge that games don't really need memory safety. After all, what really matters for game development is fast iteration times, and the worst that could happen from breaking memory safety is a crash. Sure, maybe your game will crash on 2% of startups, but players can just restart it. It's much better to use the time you would have spent tracking down rare crash bugs to, instead, improve performance, or tweak gameplay, or add new features.

    Except... not really. If your software crashes with an access violation accidentally, maybe players will lose a bit of time restarting the game. Their saves might even be corrupted, if it's a single-player game, but you can just have a backup of save files, and restore backups if you detect corruption. But you've defended against Murphy... not Satan. Your users can be minorly inconvienienced by accidental crashes, but what if an attacker triggers them?

    That's just what happened in the Source engine. Source is a game engine owned by Valve Software. It's a derivative of Valve's older GoldSrc game engine, which is, itself, a derivative of the Quake 2 engine. Source powers some of the most popular multiplayer PC games in the world, including DOTA 2 (which regularly boasts daily peaks of 800,000 or more concurrent players), Counter-Strike: Global Offensive (with daily peaks of around 600,000), and Team Fortress 2 (with around 80,000). Source is written in C++ (large parts of which were originally C, from the Quake 2 engine, and just copied-and-pasted into methods- comments and all!), and a [portion of Source's source](https://github.com/ValveSoftware/source-sdk-2013/) (confused yet?) is available as the Source SDK on Valve's GitHub account.

    Source has a mechanism with which players can "spray" custom images onto the ground, which are then visible to all other players on the same server. This mechanism is disabled in more recent games (DOTA 2 and Counter-Strike: Global Offensive), but it still works in Team Fortress 2. These images are transferred as [VTF (Valve Texture Format) files](https://developer.valvesoftware.com/wiki/Valve_Texture_Format) There are a few different versions of VTF, mostof which are fairly minor updates.

    In VTF 7.3, however, the structure of the format was changed fairly dramatically. Previously, the actual image data was stored immediately after a small "thumbnail" image, which was itself stored immediately after the header. In 7.3, however, the header was followed by a "directory" describing the offsets at which the image data (and thumbnail) could be found. When loading a VTF, the Source engine calls the `CVTF::FindResourceEntryInfo` function to search the directory for the image data and thumbnail. This function returns NULL if it can't find the specified entry in the image directory. Luckily, the engine checks the return value of this function... via `Assert`. Which is disabled in release builds, and even if it wasn't, a VTF with a crafted (or simply truncated) directory would still crash the game- it would just pop up a nice MessageBox while doing it.

    You can probably tell where this is going. If a user selects, as their spray image, a VTF file with no entry for the image data in its directory, and sprays it, all other players in the game load that VTF file. And when they do, their games instantly crash and dump them out of the game and back to desktop.  It's quite an eerie sight- a server of 32 players, playing a lively game, when suddenly everything just stops. Players talking on voice chat stop in mid-sentence. The gameserver leaves players connected for a while (before eventually kicking them for not responding to pings), but since they stop sending their movement to the server, players appear to simply freeze- even when in mid-air. I wasn't the first person to find this exploit- apparently, various people have found it independently, since you can trigger it simply by truncating a VTF file (and cutting off the directory). [Videos exist of people exploiting this "in the wild", if you want to see what it looks like.](https://www.youtube.com/watch?v=-yKfi6TnpjU)

    But, at the end of the day, this is just a neat DoS issue. There's nothing really harmful, in the long-term, about it. That's not true for this next issue...
